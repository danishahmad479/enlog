<!-- templates/my-orders-page.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <h1 class="text-2xl font-bold mb-6">My Orders</h1>
        <div class="flex justify-between items-center mb-4">
    <button onclick="goBack()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">⬅ Back</button>
  </div>
  <div id="orders-container" class="space-y-6"></div>

  <script>
    // Global toast notification system
    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toast-container');
      if (!toastContainer) return;

      const toast = document.createElement('div');
      toast.className = `p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
      
      // Set colors based on type
      switch(type) {
        case 'success':
          toast.className += ' bg-green-500 text-white';
          break;
        case 'error':
          toast.className += ' bg-red-500 text-white';
          break;
        case 'warning':
          toast.className += ' bg-yellow-500 text-white';
          break;
        default:
          toast.className += ' bg-blue-500 text-white';
      }
      
      toast.innerHTML = `
        <div class="flex items-center justify-between">
          <span>${message}</span>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
            ✕
          </button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      
      // Animate in
      setTimeout(() => {
        toast.classList.remove('translate-x-full');
      }, 100);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 300);
      }, 5000);
    }

    // WebSocket notification system
    function initializeWebSocket() {
      const userId = localStorage.getItem("user_id");
      if (!userId) return;

      const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
      const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/orders/${userId}/`);

      socket.onopen = function (e) {
        console.log("WebSocket connection established on orders page");
      };

      socket.onmessage = function (e) {
        try {
          const data = JSON.parse(e.data);
          console.log("Received notification on orders page:", data);
          
          if (data.type === 'notification') {
            showToast(data.message, 'success');
            // Refresh the page to show updated order status
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          }
        } catch (error) {
          console.error("Error parsing WebSocket message:", error);
        }
      };

      socket.onclose = function (e) {
        console.log("WebSocket connection closed on orders page");
      };

      socket.onerror = function (e) {
        console.error("WebSocket error on orders page:", e);
      };
    }

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/my-orders/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('accessToken'), // or use cookies/session if applicable
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Authentication required or failed');
            }
            return response.json();
        })
        .then(orders => {
            const container = document.getElementById('orders-container');
            if (orders.length === 0) {
                container.innerHTML = "<p>No orders found.</p>";
                return;
            }

            orders.forEach(order => {

                const productNames = order.items.map(item => item.product.name).join(', ');


                const itemsHtml = order.items.map(item => `
                    <li>${item.product.name} - Qty: ${item.quantity} - ₹${item.price}</li>
                `).join('');


                const orderHtml = `
                    <div class="border p-4 rounded bg-white shadow">
                        <h2 class="text-lg font-semibold">Order ${order.id} - Products: ${productNames}</h2>
                        <p>Status: <strong>${order.status}</strong></p>
                        <p>Total: ₹${order.total_amount}</p>
                        <p>Placed on: ${new Date(order.created_at).toLocaleString()}</p>
                        <ul class="ml-4 list-disc mt-2">${itemsHtml}</ul>
                    </div>
                `;

                container.innerHTML += orderHtml;
            });
        })
        .catch(error => {
            document.getElementById('orders-container').innerHTML = `<p class="text-red-600">${error.message}</p>`;
        });
    });

    function goBack() {
      window.location.href = "/";
    }

    // Initialize WebSocket when page loads
    document.addEventListener('DOMContentLoaded', initializeWebSocket);
  </script>
</body>
</html>
