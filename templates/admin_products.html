<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Manage Products</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Manage Products</h2>
      <a href="/categories-page/" class="text-blue-600 font-medium hover:underline">‚Üê Back</a>
    </div>

    <button onclick="openModal()" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">
      Add Product
    </button>

    <!-- Product Table -->
    <div id="productTable" class="overflow-x-auto"></div>

    <!-- Pagination -->
    <div class="flex justify-center mt-4 space-x-2" id="pagination-container"></div>
  </div>

  <!-- Modal -->
  <div id="productModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-10">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h3 class="text-xl font-semibold mb-4">Add / Update Product</h3>

      <input id="productId" type="hidden" />
      <input id="name" placeholder="Name" class="mb-2 w-full border px-3 py-2 rounded" />
      <textarea id="description" placeholder="Description" class="mb-2 w-full border px-3 py-2 rounded"></textarea>
      <input id="price" type="number" placeholder="Price" class="mb-2 w-full border px-3 py-2 rounded" />
      <input id="stock" type="number" placeholder="Stock" class="mb-2 w-full border px-3 py-2 rounded" />
      <select id="categoryDropdown" class="mb-4 w-full border px-3 py-2 rounded"></select>

      <div class="flex justify-between">
        <button onclick="saveProduct()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
        <button onclick="closeModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("accessToken");
    const isStaff = localStorage.getItem("is_staff");
    let currentPage = 1;
    const pageSize = 10;

    if (!token || isStaff !== "true") {
      window.location.href = "/login-page/";
    }

    function openModal(product = null) {
      document.getElementById("productModal").classList.remove("hidden");
      if (product) {
        document.getElementById("productId").value = product.id;
        document.getElementById("name").value = product.name;
        document.getElementById("description").value = product.description;
        document.getElementById("price").value = product.price;
        document.getElementById("stock").value = product.stock;
        document.getElementById("categoryDropdown").value = product.category;
      } else {
        document.getElementById("productId").value = "";
        document.querySelectorAll("#productModal input, #productModal textarea").forEach(el => el.value = "");
      }
    }

    function closeModal() {
      document.getElementById("productModal").classList.add("hidden");
    }

    async function fetchCategories() {
      const res = await fetch("http://127.0.0.1:8000/categories/", {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) {
        alert("Failed to load categories.");
        return;
      }

      const data = await res.json();
      const categories = data.results || data;
      const dropdown = document.getElementById("categoryDropdown");
      dropdown.innerHTML = "";

      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat.name;
        option.innerText = cat.name;
        dropdown.appendChild(option);
      });
    }

    async function fetchProducts(page = 1) {
      currentPage = page;
      const res = await fetch(`http://127.0.0.1:8000/products/?page=${page}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) {
        alert("Failed to load products.");
        return;
      }

      const data = await res.json();
      const products = data.results || data;

      let html = `<table class="min-w-full text-sm text-left border">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">Name</th>
            <th class="px-4 py-2 border">Description</th>
            <th class="px-4 py-2 border">Price</th>
            <th class="px-4 py-2 border">Stock</th>
            <th class="px-4 py-2 border">Category</th>
            <th class="px-4 py-2 border">Actions</th>
          </tr>
        </thead>
        <tbody>`;

      products.forEach(p => {
        html += `
          <tr class="hover:bg-gray-100">
            <td class="px-4 py-2 border">${p.name}</td>
            <td class="px-4 py-2 border">${p.description}</td>
            <td class="px-4 py-2 border">${p.price}</td>
            <td class="px-4 py-2 border">${p.stock}</td>
            <td class="px-4 py-2 border">${p.category}</td>
            <td class="px-4 py-2 border">
              <button onclick='openModal(${JSON.stringify(p)})' class="text-blue-600 hover:underline">Edit</button>
              <button onclick='deleteProduct(${p.id})' class="text-red-600 hover:underline ml-2">Delete</button>
            </td>
          </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById("productTable").innerHTML = html;

      const totalPages = Math.ceil(data.count / pageSize);
      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      const container = document.getElementById("pagination-container");
      container.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = `px-3 py-1 rounded ${i === currentPage ? "bg-blue-600 text-white" : "bg-gray-200 hover:bg-gray-300"}`;
        btn.onclick = () => fetchProducts(i);
        container.appendChild(btn);
      }
    }

    async function saveProduct() {
      const id = document.getElementById("productId").value;
      const name = document.getElementById("name").value;
      const description = document.getElementById("description").value;
      const price = document.getElementById("price").value;
      const stock = document.getElementById("stock").value;
      const category_name = document.getElementById("categoryDropdown").value;

      const payload = { name, description, price, stock, category_name };

      const url = id
        ? `http://127.0.0.1:8000/products/${id}/`
        : `http://127.0.0.1:8000/products/`;
      const method = id ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        closeModal();
        fetchProducts(currentPage);
      } else {
        const errorData = await res.json();
        if (errorData.name && errorData.name[0]) {
          alert(errorData.name[0]);
        } else {
          alert("Error saving product.");
        }
      }
    }

    async function deleteProduct(id) {
      if (!confirm("Are you sure you want to delete this product?")) return;

      const res = await fetch(`http://127.0.0.1:8000/products/${id}/`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (res.ok) {
        fetchProducts(currentPage);
      } else {
        alert("Failed to delete product.");
      }
    }

    // Initial load
    fetchCategories();
    fetchProducts();
  </script>
</body>
</html>
