<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Manage Categories</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
<div class="flex justify-between items-center mb-4">
  <h2 class="text-2xl font-bold">Manage Categories</h2>
  <div class="flex items-center space-x-3">
    
    <a href="/admin-products-page/" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
      Add Products
    </a>

    <div onclick="logout()" style="cursor: pointer; font-size: 24px;">ðŸšª</div>
  </div>
</div>

    <button onclick="openModal()" class="bg-green-600 text-white px-4 py-2 rounded mb-4 hover:bg-green-700">
      Add Category
    </button>

    <!-- Category Table -->
    <div id="categoryTable" class="overflow-x-auto"></div>

    <!-- Pagination -->
    <div class="flex justify-center mt-4 space-x-2" id="pagination-container"></div>
  </div>

  <!-- Modal -->
  <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden z-10">
    <div class="bg-white p-6 rounded-lg w-96 shadow-lg">
      <h3 class="text-xl font-semibold mb-4">Add / Update Category</h3>

      <input id="categoryId" type="hidden" />
      <input id="name" placeholder="Name" class="mb-2 w-full border px-3 py-2 rounded" />
      <textarea id="description" placeholder="Description" class="mb-4 w-full border px-3 py-2 rounded"></textarea>

      <div class="flex justify-between">
        <button onclick="saveCategory()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
        <button onclick="closeModal()" class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("accessToken");
    const refreshToken = localStorage.getItem("refreshToken");
    const isStaff = localStorage.getItem("is_staff");
    let currentPage = 1;
    const pageSize = 10;

    if (!token || isStaff !== "true") {
      window.location.href = "/login-page/";
    }

    function openModal(category = null) {
      document.getElementById("categoryModal").classList.remove("hidden");
      if (category) {
        document.getElementById("categoryId").value = category.id;
        document.getElementById("name").value = category.name;
        document.getElementById("description").value = category.description;
      } else {
        document.getElementById("categoryId").value = "";
        document.querySelectorAll("#categoryModal input, #categoryModal textarea").forEach(el => el.value = "");
      }
    }

    function closeModal() {
      document.getElementById("categoryModal").classList.add("hidden");
    }

    async function fetchCategories(page = 1) {
      currentPage = page;
      const res = await fetch(`http://127.0.0.1:8000/categories/?page=${page}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) {
        alert("Failed to load categories.");
        return;
      }

      const data = await res.json();
      const categories = data.results || data;

      let html = `<table class="min-w-full text-sm text-left border">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">Name</th>
            <th class="px-4 py-2 border">Description</th>
            <th class="px-4 py-2 border">Actions</th>
          </tr>
        </thead>
        <tbody>`;

      categories.forEach(cat => {
        html += `
          <tr class="hover:bg-gray-100">
            <td class="px-4 py-2 border">${cat.name}</td>
            <td class="px-4 py-2 border">${cat.description || ""}</td>
            <td class="px-4 py-2 border">
              <button onclick='openModal(${JSON.stringify(cat)})' class="text-blue-600 hover:underline">Edit</button>
              <button onclick='deleteCategory(${cat.id})' class="text-red-600 hover:underline ml-2">Delete</button>
            </td>
          </tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById("categoryTable").innerHTML = html;

      const totalPages = Math.ceil(data.count / pageSize);
      renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
      const container = document.getElementById("pagination-container");
      container.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.innerText = i;
        btn.className = `px-3 py-1 rounded ${i === currentPage ? "bg-blue-600 text-white" : "bg-gray-200 hover:bg-gray-300"}`;
        btn.onclick = () => fetchCategories(i);
        container.appendChild(btn);
      }
    }

    async function saveCategory() {
      const id = document.getElementById("categoryId").value;
      const name = document.getElementById("name").value;
      const description = document.getElementById("description").value;

      const payload = { name, description };

      const url = id
        ? `http://127.0.0.1:8000/categories/${id}/`
        : `http://127.0.0.1:8000/categories/`;
      const method = id ? "PUT" : "POST";

      const res = await fetch(url, {
        method,
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        closeModal();
        fetchCategories(currentPage);
      } else {
        const errorData = await res.json();
        if (errorData.name && errorData.name[0]) {
          alert(errorData.name[0]);
        } else {
          alert("Error saving category.");
        }
      }
    }

    async function deleteCategory(id) {
      if (!confirm("Are you sure you want to delete this category?")) return;

      const res = await fetch(`http://127.0.0.1:8000/categories/${id}/`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (res.ok) {
        fetchCategories(currentPage);
      } else {
        alert("Failed to delete category.");
      }
    }

    function logout() {
      if (refreshToken) {
        fetch("http://127.0.0.1:8000/logout/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({ refresh: refreshToken }),
        }).finally(() => {
          localStorage.removeItem("accessToken");
          localStorage.removeItem("refreshToken");
          window.location.href = "/login-page/";
        });
      } else {
        localStorage.removeItem("accessToken");
        localStorage.removeItem("refreshToken");
        window.location.href = "/login-page/";
      }
    }

    // Load categories on page load
    fetchCategories();
  </script>
</body>
</html>
